---
title: "iOSã«ãŠã‘ã‚‹ã€Œè§¦è¦šã‚¿ãƒƒãƒã€ã¨ã€Œ3D Touchã€ã«ã¤ã„ã¦ã®ãŠã•ã‚‰ã„ã¨ç„¡åŠ¹åŒ–æ–¹æ³•"
emoji: "â˜ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["UIKit", "Swift"]
published: true
---
ã“ã‚“ã«ã¡ã¯ã€[æ‘æ¾é¾ä¹‹ä»‹@Riscait](https://twitter.com/riscait)ã§ã™ã€‚

ã“ã®è¨˜äº‹ã¯ã€ [iOS Advent Calendar 2020 | Qiita](https://qiita.com/advent-calendar/2020/ios) 19æ—¥ç›®ã®è¨˜äº‹ã§ã™ğŸ’ª

ä»Šå›ã€3D Touch ã¨è§¦è¦šã‚¿ãƒƒãƒã«ã¤ã„ã¦å·®ç•°ã‚’æ„è­˜ã—ãªãŒã‚‰ç„¡åŠ¹åŒ–ã—ãªã‘ã‚Œã°ã„ã‘ãªã„æ©Ÿä¼šãŒã‚ã‚Šã¾ã—ãŸã®ã§ã€å‚™å¿˜éŒ²ãŒã¦ã‚‰ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚

## 3D Touchã¨ã¯
3D Touchã¯ã€åœ§åŠ›ï¼ˆãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã®æŠ¼ã—è¾¼ã¿ï¼‰ã‚’æ¤œçŸ¥ã§ãã‚‹æ©Ÿèƒ½ã§ã™ã€‚
ç‰¹å®šã®ç«¯æœ«ã®ã¿åˆ©ç”¨ã§ãã‚‹æ©Ÿèƒ½ã§ã€ç›´è¿‘ã®iPhoneç«¯æœ«ã§ã¯å»ƒæ­¢ã•ã‚Œã¦ã„ã¾ã™ã€‚

### 3D TouchãŒä½¿ãˆã‚‹ç«¯æœ«
* iPhone 6s, iPhone 6 Plus
* iPhone 7, iPhone 7 Plus
* iPhone 8, iPhone 8 Plus
* iPhone X,
* iPhone XS, iPhone XS Max

ä¸Šè¨˜ã®ç«¯æœ«ã¯ã€iOS 13ä»¥ä¸Šã§ã‚ã‚Œã°å¾Œè¿°ã®è§¦è¦šã‚¿ãƒƒãƒã‚‚åˆ©ç”¨å¯èƒ½ã§ã™ã€‚

## è§¦è¦šã‚¿ãƒƒãƒ (Haptic Touch)ã¨ã¯
é•·æŠ¼ã—ã‚’æ¤œçŸ¥ã—æŒ¯å‹•ã•ã›ã‚‹ï¼ˆåœ§åŠ›ã¯æ¤œçŸ¥ã§ããªã„ï¼‰æ©Ÿèƒ½ã§ã™ã€‚
æŒ¯å‹•ã•ã›ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€æ“¬ä¼¼çš„ã«æŠ¼ã—è¾¼ã¿ã‚’è¡¨ç¾ã—ã¦ã„ã¾ã™ã€‚
3D Touchã¨é•ã„ã€ç‰¹å®šã®ç«¯æœ«ã®ã¿ã¨ã„ã†ã‚ã‘ã§ãªãã€iOS 13ä»¥ä¸Šã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚

ä¾‹ãˆã°ã€

* iPhone XR ã‚„ã€
* iPhone 11, iPhone 11 Pro, iPhone 11 Pro Max å«ã‚€æ–°ã—ã„ç«¯æœ«

ã¯ã€**ã€Œ3D Touchã€ã«ã¯å¯¾å¿œã—ã¦ã„ãªã„**ãŸã‚ã€ã€Œè§¦è¦šã‚¿ãƒƒãƒã€ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚

## iPhone 6 ä»¥å‰ã®ç«¯æœ«ã‹ã¤ iOS 13 æœªæº€ã¯ã€ã©ã¡ã‚‰ã‚‚ä½¿ãˆãªã„
iPhone 6, iPhone 6 Plus ã¨ãã‚Œä»¥å‰ã®ç«¯æœ«ã§ã¯ã€3D Touchéå¯¾å¿œã§ã™ã€‚
ã•ã‚‰ã« iOS 13æœªæº€ã®å ´åˆã¯è§¦è¦šã‚¿ãƒƒãƒã‚‚ä½¿ãˆãªã„ãŸã‚ã€ã©ã¡ã‚‰ã‚‚ä½¿ãˆãªã„ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

## 3D TouchãŒä½¿ãˆã‚‹ãƒ‡ãƒã‚¤ã‚¹ãªã®ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹æ–¹æ³•
3D Touchã¯ç‰¹å®šã®ç«¯æœ«ã®ã¿åˆ©ç”¨å¯èƒ½ã§ã™ã€‚
ã•ã‚‰ã«è¨­å®šã§OFFã«ã‚‚ã§ãã‚‹ãŸã‚ã€åˆ©ç”¨å¯èƒ½çŠ¶æ…‹ã«ã‚ã‚‹ã‹ã€ã‚³ãƒ¼ãƒ‰ä¸Šã§ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

[`UITraitCollection`](https://developer.apple.com/documentation/uikit/uitraitcollection) ã® [`forceTouchCapability`](https://developer.apple.com/documentation/uikit/uitraitcollection/1623515-forcetouchcapability)ã§ç¢ºèªã§ãã¾ã™ã€‚

UIViewControllerä¸Šã§ã‚ã‚Œã°ã€ `.traitCollection` ãŒãã®ã¾ã¾ä½¿ãˆã¾ã™ã€‚

çµæœã¨ã—ã¦è¿”ã£ã¦ãã‚‹enumã¯ä»¥ä¸‹ã®3ã¤ã§ã™ã€‚
[`UIForceTouchCapability`](https://developer.apple.com/documentation/uikit/uiforcetouchcapability)

```swift
switch traitCollection.forceTouchCapability {
case .unknown:     // 0: unknownï¼ˆä¸æ˜ï¼‰
case .unavailable: // 1: unavailableï¼ˆåˆ©ç”¨ä¸å¯ï¼‰
case .available:   // 2: availableï¼ˆåˆ©ç”¨å¯èƒ½ï¼‰
@unknown default:
}
```

[UIButtonã«3DTouchåˆ¤å®šã‚’è¿½åŠ ã—ã¦ã‚¢ãƒŠãƒ­ã‚°ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã—ãŸã„](http://tazk.hatenablog.com/entry/2015/09/26/231430)
ã¾ãŸã€ã“ã¡ã‚‰ã®è¨˜äº‹ã«ã¯Objective-Cã ã¨ã€ `viewDidLoad` ã§ã¯åˆ¤å®šãŒã§ããªã„ã¨ã‚ã‚Šã¾ã—ãŸãŒã€åƒ•ã®ç’°å¢ƒã§ã¯ObjCã§ã‚‚åˆ¤å®šå¯èƒ½ã§ã—ãŸã€‚

## 3D Touchã¨è§¦è¦šã‚¿ãƒƒãƒã«ã‚ˆã‚‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹æ–¹æ³•
[`allowsLinkPreview`](https://developer.apple.com/documentation/webkit/wkwebview/1415000-allowslinkpreview)
ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

iOS 10ä»¥é™ã§ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§trueã¨ãªã£ã¦ã„ã‚‹ã®ã§ã€ `allowsLinkPreview = false` ã¨ã™ã‚Œã°OKã§ã™ã€‚

ã‚¿ãƒƒãƒå¯¾è±¡ã«ã‚ˆã‚Šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã•ã›ã‚‹ã‹ã©ã†ã‹å‹•çš„ã«æŒ¯ã‚Šåˆ†ã‘ãŸã„å ´åˆã¯ã€ã€€`iOS 10.0â€“13.0 (Deprecated)` ã§ã™ãŒã€ã„ã‹ã®APIãŒã‚ã‚Šã¾ã™ã€‚
[`optional func webView(_:shouldPreviewElement:) -> Bool`](https://developer.apple.com/documentation/webkit/wkuidelegate/1648359-webview)

## ä½™è«‡
### WKWebViewã§é–‹ã‘ã‚‹ActionSheetã‚’ç„¡åŠ¹ã«ã™ã‚‹
WKWebViewã§ã¯ã€3D Touchã‚„è§¦è¦šã‚¿ãƒƒãƒã‚’ä½¿ã†ã¨ãƒªãƒ³ã‚¯ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã¾ã™ãŒã€ã“ã¡ã‚‰ã‚‚ `allowsLinkPreview = false` ã§ç„¡åŠ¹åŒ–ã§ãã¾ã™ã€‚

3D Touch, è§¦è¦šã‚¿ãƒƒãƒã¨ã‚‚ã«éå¯¾å¿œãªç«¯æœ«ã§ã¯ã©ã†ãªã‚‹ã‹ã¨ã„ã†ã¨ã€ä»£ã‚ã‚Šã« ActionSheet ãŒé–‹ãã¾ã™ã€‚
ã“ã‚Œã‚’ç„¡åŠ¹ã«ã™ã‚‹æ–¹æ³•ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚

WKWebViewåˆæœŸåŒ–æ™‚ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ³¨å…¥ã—ã¾ã™ã€‚

```swift
// 3D Touchã¨è§¦è¦šã‚¿ãƒƒãƒã«æœªå¯¾å¿œã®ãƒ‡ãƒã‚¤ã‚¹ã®é•·æŠ¼ã—ã§è¡¨ç¤ºã•ã‚Œã‚‹ActionSheetã‚’ç„¡åŠ¹åŒ–
let contentController = WKUserContentController()
// æ³¨å…¥ã—ãŸã„JavaScriptã‚’å®šç¾©ã—ã¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã«è¿½åŠ 
let userScript = WKUserScript(
    source: "document.documentElement.style.webkitTouchCallout='none';",
    injectionTime: .atDocumentStart,
    forMainFrameOnly: true
)
contentController.addUserScript(userScript)
// WKWebViewã®åˆæœŸåŒ–æ™‚ã«æŒ‡å®šã™ã‚‹Configurationã‚¯ãƒ©ã‚¹ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ã‚»ãƒƒãƒˆ
let webViewConfig = WKWebViewConfiguration()
webViewConfig.userContentController = contentController
// Configurationã‚’ä½¿ç”¨ã—ã¦WKWebViewã‚’ç”Ÿæˆ
webView = WKWebView(frame: .zero, configuration: webViewConfig)
```

```objective-c
// 3D Touchã¨è§¦è¦šã‚¿ãƒƒãƒã«æœªå¯¾å¿œã®ãƒ‡ãƒã‚¤ã‚¹ã®é•·æŠ¼ã—ã§è¡¨ç¤ºã•ã‚Œã‚‹ActionSheetã‚’ç„¡åŠ¹åŒ–
WKUserContentController *contentController = [[WKUserContentController alloc] init];
// æ³¨å…¥ã—ãŸã„JavaScriptã‚’å®šç¾©ã—ã¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã«è¿½åŠ 
WKUserScript *script = [[WKUserScript alloc]
                        initWithSource:@"document.documentElement.style.webkitTouchCallout='none';"
                        injectionTime:WKUserScriptInjectionTimeAtDocumentStart
                        forMainFrameOnly:YES];
[contentController addUserScript:script];
// WKWebViewã®åˆæœŸåŒ–æ™‚ã«æŒ‡å®šã™ã‚‹Configurationã‚¯ãƒ©ã‚¹ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ã‚»ãƒƒãƒˆ
WKWebViewConfiguration * config = [[WKWebViewConfiguration alloc] init];
[config setUserContentController:contentController];
// Configurationã‚’ä½¿ç”¨ã—ã¦WKWebViewã‚’ç”Ÿæˆ
self.webView = [[WKWebView alloc] initWithFrame:CGRectZero configuration:config];
```

## å‚è€ƒãƒªãƒ³ã‚¯
[Making Javascript feel like native iOS with WKWebView](https://medium.com/@maxcampolo/making-javascript-feel-like-native-ios-with-wkwebview-d92dfefe8d56)

ã”é–²è¦§ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼

Twitterã§ã¯ã€ä¸»ã«Flutterãƒ»Firebaseãƒ»iOS/Swift, ã«ã¤ã„ã¦å‘Ÿã„ã¦ãŠã‚Šã¾ã™ã€‚
ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ãŸã ã‘ã‚Œã°å¬‰ã—ã„ã§ã™â˜ºï¸ â†’ ğŸ¦æ‘æ¾é¾ä¹‹ä»‹[@Riscait](https://twitter.com/riscait)Â 